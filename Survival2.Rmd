---
title: "Survival part 2"
author: "Erin Feichtinger"
date: "Tuesday, January 26, 2016"
output: html_document
---




```{r, echo=FALSE}
setwd("C:/Users/Erin/LittleBlueDinos")
library(survival)
library(car)
library(kinship2)
df <- read.csv(file="Breeders_Fall.csv")
april.dates <- read.csv(file="April_Census_Dates.csv")
apdat <- as.list(april.dates)

#remove duplicate records (because I still have mulitple records for each individual)
brdrs <- df[!duplicated(df),]

#convert dates to date format
brdrs$FirstDateBred <- as.Date(brdrs$FirstDateBred, format = "%m/%d/%Y")
brdrs$LastObsDate <- as.Date(brdrs$LastObsDate, format = "%m/%d/%Y")

#get year only for YrClass
year <- as.POSIXlt(brdrs$LastObsDate)$year+1900
brdrs["YrDied"]<- year
brdrs$Yr <- as.numeric(brdrs$Yr)

#subtract dates to get number of days
date.diff<- brdrs$LastObsDate-brdrs$FirstDateBred

#add to data frame
brdrs["days"] <- date.diff
brdrs$days <-as.numeric(brdrs$days)

brdrs["yrs"] <- brdrs$days/365

brdrs$FirstDateBred <- as.numeric(brdrs$FirstDateBred)
brdrs$LastObsDate <- as.numeric(brdrs$LastObsDate)

#add censorship, 0 = alive/right censored, 1 = dead after 1st year breeding, novice
brdrs["censorshipnov"] <- NA
brdrs$censorshipnov <- 1

#this is not quite right. I want the day of the April census the year 
#following becoming a breeder for the first time, so instead of 365, 
#something like April Census year of 1st breeding + 1? I don't know 
#the R snytax for this.
brdrs$censorshipnov[which(brdrs$days>=365)]<- 0

#censorship status for breeding span after first year, exper breeders
brdrs["censorship"] <- 1
#add 0's to those still alive 2015-06-17
brdrs$censorship[which(brdrs$LastObsDate=="2015-06-17")]<-0


#get rid of birds breeding before 1980
brdrs.new <- subset(brdrs, FirstYr > 1980, select=ID:censorship)

#I don't know if it is necessary to take out the NA's
brdrs.new <- na.omit(brdrs.new)

#Create survival object - have to find some way to account for birds with negative days
my.survyr <- Surv(brdrs.new$yrs, brdrs.new$censorship)
my.survdy <- Surv(brdrs.new$days, brdrs.new$censorship)
my.fityr <- survfit(my.survyr~1)
my.fitdy <- survfit(my.survdy~1)
plot(my.fitdy, xlim=c(0,4000), xlab="Days", ylab="Survival", main="Experienced and Novice Breeders")
plot(my.fityr, xlim=c(0,15), xlab="Years", ylab= "Survival", main="Experienced and Novice Breeders")
#summary(my.fitdy)

#Survival object splitting up novice and experienced breeders
#Not sure if this is the correct way to do this 
nov.surv <- Surv(brdrs.new$yrs, brdrs.new$censorshipnov, type=c('right'))
nov.fit <- survfit(nov.surv~1)
plot(nov.fit, xlim=c(0,1), xlab="Years", ylab="Cumulative Survival", main="Novice and Exp Breeders")

#FirstYr is the year that birds first bred
yr.fit <- coxph(nov.surv~brdrs.new$FirstYr, data = brdrs.new)
yr.fit
summary(yr.fit)

```


